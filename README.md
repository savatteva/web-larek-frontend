# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемые в приложении

Состояние приложения

```
interface IHomePage {
  catalog: IProduct[];
  basket: string[];
  order: IOrder | null;
  basketTotal: number; 
  preview: string | null;
}
```

Карточка товара

```
interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
  index:  number;
}
```

Оформление заказа

```
interface IOrder {
  payment: string;
  email: string;
  phone: string;
  address: string;
  items: string[];
  total: number;
}
```

Интерфейс корзины 
```
interface IBasket {
  products: HTMLElement[];
  total: number | null;
  selected: number
}
```

Интерфейс для модели данных карточки товара

```
interface IProductsData {
  products: ICard[];
  preview: string | null;
}
```
Интерфейс для контейнера товаров

```
interface IProductsContainer {
  catalog: HTMLElement[];
}
```

Интерфейс данных после отправки заказа на сервер

```
interface IOrderResult {
  id: string;
}
```

Интерфейс ответа сервера

```
interface IApi {
  getProducts: () => Promise<IProduct[]>
  orderProducts(order: IOrder): Promise<IOrderResult>
}
```

Тип для работы с некоторыми полями заказа

```
type TOrder = Pick<IOrder, 'payment' | 'address' | 'email' | 'phone'>;
```

Тип для установки метода API

```
type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

Интерфейс окна подтверждения: 

```
interface ISuccess {
  total: number;
}
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP (Model-View-Presenter), в которой презентер связан как с моделью, так и с отображением данных, но они ничего не знают друг о друге:

- слой представление, который отвечает за отображение данных на странице,
- слой данных, который отвечает за хранение и отправление данных на сервер,
- презентер, отвечающий за связь первых двух слоев (то есть слоев представления и данных)

### Базовый код

#### Класс API

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов. 


`constructor(baseUrl: string, options: RequestInit = {})`- принимает базовый URL и глобальные опции для всех запросов (опционально).

Методы: 

- `handleResponse(response: Response)` - метод принимает ответ сервера и возвращает промис с данными в случае успеха, в ином случае возвращает промис с причиной неудачного запроса

- `get` - выполняет GET-запрос на переданный в параметрах эндпоинт и возвращает `promise` с объектом, которым ответил сервер

- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на эндпоинт, переданный как параметр при вызове метода. По умолчанию выполняется `POST`-запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий. 
Основные методы, реализуемые классом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие. 

Также в классе реализованы следующие дополнительные методы:
- `onAll` -  слушать все события
- `offAll` - сбросить все обработчики

#### Базовый Класс Component <T>
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте.

`constructor (element: HTMLElement)` -  конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента

Методы: 

- `toggleClass(element: HTMLElement, className: string, force?: boolean)` - переключение класса 
- `setText(element: HTMLElement, value: unknown)` - присвоить текст
- `setDisabled(element: HTMLElement, state: boolean)` - добавить атрибут disabled
- `setHidden(element: HTMLElement)` - сделать элемент невидимым
- `setVisible(element: HTMLElement)` - сделать элемент видимым
- `setImage(element: HTMLImageElement, src: string, alt?: string)` - установить изображение
- `render(data?: Partial<T>): HTMLElement` - рендер элемента

#### Базовый класс Model
Базовый класс модели данных. 

`constructor(data: Partial<T>, protected events: IEvents)` - конструктор принимает данные и экземпляр EventEmitter

Методы: 

- `emitChanges(event: string, payload?: object)` - сообщает об изменении модели

### Слой данных

#### Класс AppState

Хранит данные о приложении. Расширяет класс Model. 

Поля класса: 

- `_products`: IProduct[] - товары;
- `_order`: IOrder - заказ;
- `_basket`: IProduct[] = [] - корзина;
- `events`: IEvents - экземпляр брокера событий;

Методы класса: 

- `clearBasket()` - очистка корзины
- `toBasket(product: IProduct)` - добавление в корзину
- `deleteFromBasket(product: IProduct)` - удаление из корзины
- `setTotal()` - подсчет суммы корзины
- `setOrderField(field: keyof TOrder, value: string)` - передаем заказ в объект для отправки на сервер

Также геттеры и сеттеры для работы с полями класса.

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных. 

#### Класс Modal <T>

Реализует модальное окно. Также предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру для закрытия модального окна по нажатию кнопки Esc, клика по оверлею и кнопке-крестику. 

- `constructor (selector: string, events: IEvents)`. Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_content: HTMLElement` - элемент модального окна
- `_closeButton` - кнопка закрытия

Методы класса: 

- `open` - открытие модального окна
- `close` - закрытие модального окна

Также сеттер для отображения контента. 

#### Класс Form<T>

Расширяет базовый класс Component. Является дженериком. 

Поля класса: 

- `_form: HTMLFormElement` - элемент формы
- `submitBtn: HTMLButtonElement` - кнопка сабмита
- `formName: string` - название формы

Методы класса: 

- `onInputChange(field: keyof IOrder, value: string)` - инициализирует событие и передает в данные для добавления в объект заказа

#### Класс Order

Расширяет класс Form. Предназначен для реализации модального окна с формой, содержащей поля ввода. При сабмите инициализирует событие, передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных. Предоставляет методы для управления активностью кнопки сохранения. 

Поля класса: 

- `cash: HTMLButtonElement` - кнопка выбора оплаты  - при получении
- `card: HTMLButtonElement` - кнопка выбора оплаты - картой
- `_address: HTMLInputElement`- элемент поля ввода адреса
- `_payment: string` - выбор типа оплаты


Методы: 

- `setPayment(button: HTMLButtonElement)` - выбор типа оплаты

Также сеттер. 

#### Класс Contacts

Расширяет класс Form. Предназначен для реализации модального окна с формой, содержащей поля ввода. При сабмите инициализирует событие, передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных. 

Поля класса: 

- `_email` - инпут элемент почты
- `_phone` - инпут элемент телефона
- `_button` - кнопка

Методы: 

Сеттеры для установки значений. 

#### Класс  Basket

Расширяет базовый класс Component. 

Поля класса: 

- `_list` - список товаров
- `_total` - общая сумма заказа
- `_button` - кнопка

Методы: 

Содержит также сеттеры значений. 

#### Класс  Product<T>

Отвечает за отображение карточки товара, в которой можно посмотреть наименование, стоимость, описание, картинку, категорию. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми генерируются соответствующие события. 

`constructor(blockName: string, container: HTMLElement, actions?: IProductActions)` -   конструктор класса передается DOM-элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки и экземпляр `EventEmitter` для инициации событий

Поля класса содержат элементы разметки элементов карточки. 

#### Класс ProductsContainer<T>

Отвечает за отображение блока с карточками на главной странице. Предоставляет сеттер `container` для полного обновления содержимого. В конструктор принимает контейнер, в котором размещаются карточки. 

`constructor (container: HTMLElement)` -   в конструктор принимает контейнер, в котором размещаются карточки

Поля класса: 

- `_catalog: HTMLElement` - каталог
- `container: HTMLElement` - контейнер, в котором размещаются карточки

#### Класс Success 

Отвечает за отображение модального окна при успешном совершении заказа.

Поля класса: 

- `_close` - кнопка закрытия
- `_total` - общая сумма заказа

Содержит сеттер установки содержимого суммы.

### Слой коммуникаций 

#### Класс LarekApi

Принимает в конструктор экземпляр класса Api и представляет методы, реализующие взаимодействие с бэкендом сервиса

`constructor(cdn: string, baseUrl: string, options?: RequestInit)` - в конструктор принимает cdn, baseUrl и опции

Поля класса: 

`readonly cdn: string;` - cdn

Методы класса: 

- `getProducts(): Promise<IProduct[]> ` - получение карточек с сервера
- `orderProducts(order: IOrder): Promise<IOrderResult>` - заказ продуктов

## Взаимодействия компонентов 

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющий роль презентера. 

Взаимодействие осуществляется за счет событий, генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`. 

В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий. 

*Список всех событий, которые могут генерироваться в системе:*

- `card:select` - выбор карточки для отображения в модальном окне
- `products:loaded`- загрузка всех товаров с сервера
- `card:addtocart` - добавление товара в корзину
- `card:deletefromcart`  - удаление товара из корзины
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окна
- `basket:open` - открытие корзины
- `order:open` - открытие заказа
- `order:submit` - отправка заказа
